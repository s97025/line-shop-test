<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>LIFF åœ˜è³¼æ¸¬è©¦</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <h2 id="status">è¼‰å…¥ä¸­...</h2>
  <p id="name"></p>
  <button onclick="testAdd()">åŠ è³¼ æ‰‹å·¥é¤…ä¹¾</button>

  <!-- ä¸»ç¨‹å¼ -->
  <script type="module">
    // =========================
    // Firebase SDK
    // =========================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore,
      doc,
      setDoc,
      getDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAk5SaAAvifvTV3dUW4mddRvvgySbdIysc",
      authDomain: "line-shop-ef578.firebaseapp.com",
      projectId: "line-shop-ef578",
      storageBucket: "line-shop-ef578.firebasestorage.app",
      messagingSenderId: "909569598609",
      appId: "1:909569598609:web:e97cd2760f1df886114b30"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // =========================
    // A. ä¸€äººä¸€å–®ï¼ˆå¯åŠ è³¼ï¼‰
    // =========================
    async function upsertMyOrder(shopId, item) {
      const profile = await liff.getProfile();
      const userId = profile.userId;
      const displayName = profile.displayName;

      const orderId = `${shopId}_${userId}`;
      const orderRef = doc(db, "orders", orderId);

      const snap = await getDoc(orderRef);

      let items = [];
      if (snap.exists()) {
        items = snap.data().items || [];
      }

      const idx = items.findIndex(i => i.productId === item.productId);
      if (idx >= 0) {
        items[idx].qty += item.qty;
      } else {
        items.push(item);
      }

      const totalAmount = items.reduce(
        (sum, i) => sum + i.price * i.qty,
        0
      );

      await setDoc(orderRef, {
        shopId,
        userId,
        displayName,
        items,
        totalAmount,
        updatedAt: serverTimestamp()
      });

      alert("âœ… å·²åŠ å…¥è³¼ç‰©è»Š");
      console.log("ðŸ›’ è¨‚å–®æ›´æ–°å®Œæˆ", orderId);
    }

    // ðŸ‘‰ æŽ›åˆ° windowï¼Œè®“ HTML æŒ‰éˆ•èƒ½å‘¼å«
    window.testAdd = () => {
      upsertMyOrder("shop001", {
        productId: "p001",
        name: "æ‰‹å·¥é¤…ä¹¾",
        price: 120,
        qty: 1
      });
    };

    // =========================
    // LIFF åˆå§‹åŒ–ï¼ˆæœ€é‡è¦ï¼‰
    // =========================
    const LIFF_ID = "2008849957-uFo5FsLU";

    liff.init({ liffId: LIFF_ID })
      .then(() => {
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        return liff.getProfile();
      })
      .then(profile => {
        if (!profile) return;
        document.getElementById("status").innerText = "ç™»å…¥æˆåŠŸ";
        document.getElementById("name").innerText =
          "ä½ å¥½ï¼Œ" + profile.displayName;
      })
      .catch(err => {
        document.getElementById("status").innerText = "éŒ¯èª¤ï¼š" + err;
        console.error(err);
      });
  </script>
</body>
</html>

<!-- force redeploy -->
