<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>LIFF åœ˜è³¼</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    button:disabled { opacity: 0.5; }
    .stat { margin-left:6px;color:#555;font-size:12px; }
  </style>
</head>
<body>

<h2 id="status">è¼‰å…¥ä¸­...</h2>
<p id="name"></p>

<div id="shop-status" style="margin-bottom:10px;font-weight:bold;"></div>

<h3>ğŸ›’ å•†å“åˆ—è¡¨</h3>
<div id="product-list"></div>

<hr>

<h3>ğŸ§º æˆ‘çš„è³¼ç‰©è»Š</h3>
<div id="cart"><i>å°šæœªåŠ å…¥ä»»ä½•å•†å“</i></div>
<p id="cart-total"></p>

<button id="submit-btn">ğŸ“¤ é€å‡ºè¨‚å–®</button>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getFirestore,
    collection,
    query,
    where,
    orderBy,
    getDocs,
    doc,
    setDoc,
    getDoc,
    updateDoc,
    serverTimestamp,
    onSnapshot
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAk5SaAAvifvTV3dUW4mddRvvgySbdIysc",
    authDomain: "line-shop-ef578.firebaseapp.com",
    projectId: "line-shop-ef578",
    storageBucket: "line-shop-ef578.firebasestorage.app",
    messagingSenderId: "909569598609",
    appId: "1:909569598609:web:e97cd2760f1df886114b30"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const SHOP_ID = "shop001";
  let SHOP_CLOSED = false;
  let productStats = {};

  // =========================
  // å•†å“çµ±è¨ˆï¼ˆå¹¾äºº / å¹¾ä»¶ï¼‰
  // =========================
  function watchProductStats() {
    const q = query(
      collection(db, "orders"),
      where("shopId", "==", SHOP_ID)
    );

    onSnapshot(q, snap => {
      const stats = {};

      snap.forEach(docSnap => {
        const data = docSnap.data();
        if (!data.items) return;

        data.items.forEach(item => {
          if (!stats[item.productId]) {
            stats[item.productId] = { people: 0, buyerCount: 0 };
          }
          stats[item.productId].people += 1;
          stats[item.productId].buyerCount += item.qty;
        });
      });

      productStats = stats;
      updateProductStatsUI();
    });
  }

  function updateProductStatsUI() {
    document.querySelectorAll("[data-product-id]").forEach(div => {
      const pid = div.dataset.productId;
      const stat = productStats[pid];
      const span = div.querySelector(".stat");

      span.innerText = stat
        ? `ğŸ‘¥ ${stat.people} äºº Â· ${stat.buyerCount} ä»¶`
        : `ğŸ‘¥ 0 äºº Â· 0 ä»¶`;
    });
  }

  // =========================
  // çµå–®ç‹€æ…‹
  // =========================
  async function getShopStatus() {
    const snap = await getDoc(doc(db, "products", SHOP_ID));
    if (!snap.exists() || !snap.data().closeAt) return { closed:false };
    const closeAt = snap.data().closeAt.toDate();
    return { closed: new Date() >= closeAt, closeAt };
  }

  // =========================
  // å•†å“åˆ—è¡¨
  // =========================
  async function loadProducts() {
    const status = await getShopStatus();
    SHOP_CLOSED = status.closed;

    const statusBox = document.getElementById("shop-status");
    statusBox.innerText = status.closed
      ? `â›” å·²çµå–®ï¼ˆ${status.closeAt.toLocaleString()}ï¼‰`
      : `ğŸŸ¢ çµå–®æ™‚é–“ï¼š${status.closeAt.toLocaleString()}`;
    statusBox.style.color = status.closed ? "red" : "green";

    const q = query(
      collection(db, "products", SHOP_ID, "items"),
      where("enabled", "==", true),
      orderBy("sort", "asc")
    );

    const snap = await getDocs(q);
    const container = document.getElementById("product-list");
    container.innerHTML = "";

    snap.forEach(docSnap => {
      const p = docSnap.data();

      const div = document.createElement("div");
      div.dataset.productId = docSnap.id;
      div.style.marginBottom = "6px";

      const stat = productStats[docSnap.id];
      div.innerHTML = `
        ${p.name} $${p.price}
        <span class="stat">
          ğŸ‘¥ ${stat ? stat.people : 0} äºº Â· ${stat ? stat.buyerCount : 0} ä»¶
        </span>
      `;

      const btn = document.createElement("button");
      btn.innerText = SHOP_CLOSED ? "å·²çµå–®" : "åŠ å…¥è³¼ç‰©è»Š";
      btn.disabled = SHOP_CLOSED;
      btn.onclick = () => !SHOP_CLOSED && upsertMyOrder(docSnap.id, p);

      div.appendChild(btn);
      container.appendChild(div);
    });
  }

  // =========================
  // åŠ è³¼
  // =========================
  async function upsertMyOrder(productId, p) {
    const profile = await liff.getProfile();
    const ref = doc(db, "orders", `${SHOP_ID}_${profile.userId}`);
    const snap = await getDoc(ref);

    let items = snap.exists() ? snap.data().items || [] : [];
    const idx = items.findIndex(i => i.productId === productId);
    if (idx >= 0) items[idx].qty += 1;
    else items.push({ productId, name:p.name, price:p.price, qty:1 });

    const totalAmount = items.reduce((s,i)=>s+i.price*i.qty,0);

    await setDoc(ref, {
      shopId: SHOP_ID,
      userId: profile.userId,
      displayName: profile.displayName,
      items,
      totalAmount,
      updatedAt: serverTimestamp()
    });
  }

  // =========================
  // è³¼ç‰©è»Š
  // =========================
  async function watchCart() {
    const profile = await liff.getProfile();
    const ref = doc(db, "orders", `${SHOP_ID}_${profile.userId}`);
    const submitBtn = document.getElementById("submit-btn");

    onSnapshot(ref, snap => {
      const cart = document.getElementById("cart");
      const total = document.getElementById("cart-total");

      if (!snap.exists()) {
        cart.innerHTML = "<i>å°šæœªåŠ å…¥ä»»ä½•å•†å“</i>";
        total.innerText = "";
        return;
      }

      const d = snap.data();
      cart.innerHTML = "";
      d.items.forEach(i=>{
        cart.innerHTML += `<div>${i.name} Ã— ${i.qty} = $${i.price*i.qty}</div>`;
      });
      total.innerText = `ğŸ’° ç¸½é‡‘é¡ï¼š$${d.totalAmount}`;

      submitBtn.disabled = SHOP_CLOSED || !!d.submittedAt;
      submitBtn.innerText = SHOP_CLOSED ? "å·²çµå–®" : d.submittedAt ? "å·²é€å‡º" : "ğŸ“¤ é€å‡ºè¨‚å–®";
    });

    submitBtn.onclick = async () => {
      if (SHOP_CLOSED) return;
      await updateDoc(ref,{ submittedAt: serverTimestamp() });
      alert("âœ… è¨‚å–®å·²é€å‡º");
    };
  }

  // =========================
  // LIFF init
  // =========================
  const LIFF_ID = "2008849957-uFo5FsLU";

  liff.init({ liffId: LIFF_ID })
    .then(()=>liff.isLoggedIn()?liff.getProfile():liff.login())
    .then(p=>{
      if (!p) return;
      document.getElementById("status").innerText = "ç™»å…¥æˆåŠŸ";
      document.getElementById("name").innerText = "ä½ å¥½ï¼Œ"+p.displayName;
      loadProducts();
      watchCart();
      watchProductStats();
    });
</script>

</body>
</html>
