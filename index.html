<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>LIFF åœ˜è³¼æ¸¬è©¦</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>

<h2 id="status">è¼‰å…¥ä¸­...</h2>
<p id="name"></p>

<h3>ğŸ›’ å•†å“åˆ—è¡¨</h3>
<div id="product-list"></div>

<hr>

<h3>ğŸ› æˆ‘çš„è³¼ç‰©è»Š</h3>
<div id="cart"><i>å°šæœªåŠ å…¥ä»»ä½•å•†å“</i></div>
<p id="cart-total"></p>

<script type="module">
  // =========================
  // Firebase SDK
  // =========================
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getFirestore,
    collection,
    query,
    where,
    orderBy,
    getDocs,
    doc,
    setDoc,
    getDoc,
    serverTimestamp,
    onSnapshot
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAk5SaAAvifvTV3dUW4mddRvvgySbdIysc",
    authDomain: "line-shop-ef578.firebaseapp.com",
    projectId: "line-shop-ef578",
    storageBucket: "line-shop-ef578.firebasestorage.app",
    messagingSenderId: "909569598609",
    appId: "1:909569598609:web:e97cd2760f1df886114b30"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // =========================
  // A. ä¸€äººä¸€å–®ï¼ˆå¯åŠ è³¼ï¼‰
  // =========================
  async function upsertMyOrder(shopId, item) {
    const profile = await liff.getProfile();
    const userId = profile.userId;
    const displayName = profile.displayName;

    const orderId = `${shopId}_${userId}`;
    const orderRef = doc(db, "orders", orderId);
    const snap = await getDoc(orderRef);

    let items = [];
    if (snap.exists()) items = snap.data().items || [];

    const idx = items.findIndex(i => i.productId === item.productId);
    if (idx >= 0) items[idx].qty += 1;
    else items.push({ ...item, qty: 1 });

    const totalAmount = items.reduce(
      (sum, i) => sum + i.price * i.qty,
      0
    );

    await setDoc(orderRef, {
      shopId,
      userId,
      displayName,
      items,
      totalAmount,
      updatedAt: serverTimestamp()
    });
  }

  // =========================
  // A-1. å•†å“åˆ—è¡¨ï¼ˆå¾ Firestoreï¼‰
  // =========================
  async function loadProducts(shopId) {
    const q = query(
      collection(db, "products", shopId, "items"),
      where("enabled", "==", true),
      orderBy("sort", "asc")
    );

    const snap = await getDocs(q);
    const container = document.getElementById("product-list");
    container.innerHTML = "";

    snap.forEach(docSnap => {
      const p = docSnap.data();

      const btn = document.createElement("button");
      btn.innerText = `ï¼‹ åŠ è³¼ ${p.name}  $${p.price}`;
      btn.onclick = () => {
        upsertMyOrder(shopId, {
          productId: docSnap.id,
          name: p.name,
          price: p.price
        });
      };

      const div = document.createElement("div");
      div.style.marginBottom = "6px";
      div.appendChild(btn);
      container.appendChild(div);
    });
  }

  // =========================
  // C-1. å³æ™‚è³¼ç‰©è»Š
  // =========================
  async function watchMyOrder(shopId) {
    const profile = await liff.getProfile();
    const orderRef = doc(db, "orders", `${shopId}_${profile.userId}`);

    onSnapshot(orderRef, snap => {
      const cart = document.getElementById("cart");
      const total = document.getElementById("cart-total");

      if (!snap.exists()) {
        cart.innerHTML = "<i>å°šæœªåŠ å…¥ä»»ä½•å•†å“</i>";
        total.innerText = "";
        return;
      }

      const data = snap.data();
      cart.innerHTML = "";

      data.items.forEach(i => {
        const div = document.createElement("div");
        div.innerText = `${i.name} Ã— ${i.qty} = $${i.price * i.qty}`;
        cart.appendChild(div);
      });

      total.innerText = `ğŸ’° ç¸½é‡‘é¡ï¼š$${data.totalAmount}`;
    });
  }

  // =========================
  // LIFF åˆå§‹åŒ–
  // =========================
  const LIFF_ID = "2008849957-uFo5FsLU";

  liff.init({ liffId: LIFF_ID })
    .then(() => {
      if (!liff.isLoggedIn()) {
        liff.login();
        return;
      }
      return liff.getProfile();
    })
    .then(profile => {
      if (!profile) return;

      document.getElementById("status").innerText = "ç™»å…¥æˆåŠŸ";
      document.getElementById("name").innerText = "ä½ å¥½ï¼Œ" + profile.displayName;

      loadProducts("shop001");
      watchMyOrder("shop001");
    })
    .catch(err => {
      document.getElementById("status").innerText = "éŒ¯èª¤ï¼š" + err;
      console.error(err);
    });
</script>
</body>
</html>

<!-- force redeploy -->
