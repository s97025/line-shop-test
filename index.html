<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>LIFF åœ˜è³¼</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    button:disabled {
      opacity: 0.5;
    }
  </style>
</head>
<body>

<h2 id="status">è¼‰å…¥ä¸­...</h2>
<p id="name"></p>

<div id="shop-status" style="margin-bottom:10px;font-weight:bold;"></div>

<h3>ğŸ›’ å•†å“åˆ—è¡¨</h3>
<div id="product-list"></div>

<hr>

<h3>ğŸ§º æˆ‘çš„è³¼ç‰©è»Š</h3>
<div id="cart"><i>å°šæœªåŠ å…¥ä»»ä½•å•†å“</i></div>
<p id="cart-total"></p>

<button id="submit-btn">ğŸ“¤ é€å‡ºè¨‚å–®</button>

<script type="module">
  // =========================
  // Firebase SDK
  // =========================
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getFirestore,
    collection,
    query,
    where,
    orderBy,
    getDocs,
    doc,
    setDoc,
    getDoc,
    updateDoc,
    serverTimestamp,
    onSnapshot
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAk5SaAAvifvTV3dUW4mddRvvgySbdIysc",
    authDomain: "line-shop-ef578.firebaseapp.com",
    projectId: "line-shop-ef578",
    storageBucket: "line-shop-ef578.firebasestorage.app",
    messagingSenderId: "909569598609",
    appId: "1:909569598609:web:e97cd2760f1df886114b30"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const SHOP_ID = "shop001";
  let SHOP_CLOSED = false;
  let productStats = {};

  // =========================
  // å–å¾—çµ±è¨ˆç›®å‰è¨‚å–®ç´¯ç©æ•¸é‡ç‹€æ…‹
  // =========================
  function watchProductStats(shopId) {
    const q = query(
      collection(db, "orders"),
      where("shopId", "==", shopId)
    );
  
    onSnapshot(q, snap => {
      const stats = {};
  
      snap.forEach(docSnap => {
        const data = docSnap.data();
        if (!data.items) return;
  
        data.items.forEach(item => {
          if (!stats[item.productId]) {
            stats[item.productId] = { people: 0, buyerCount: 0 };
          }
          stats[item.productId].people += 1;
          stats[item.productId].buyerCount += item.buyerCount;
        });
      });
  
      productStats = stats;
  
      // ğŸ”¥ é‡æ–°æ¸²æŸ“å•†å“åˆ—è¡¨ï¼ˆåªæ›´æ–°æ•¸å­—ï¼‰
      updateProductStatsUI();
    });
  }

  
  // =========================
  // å–å¾—çµå–®ç‹€æ…‹
  // =========================
  async function getShopStatus() {
    const ref = doc(db, "products", SHOP_ID);
    const snap = await getDoc(ref);

    if (!snap.exists() || !snap.data().closeAt) {
      return { closed: false };
    }

    const closeAt = snap.data().closeAt.toDate();
    const now = new Date();

    return {
      closed: now >= closeAt,
      closeAt
    };
  }

  // =========================
  // å•†å“åˆ—è¡¨
  // =========================
  async function loadProducts() {
    const status = await getShopStatus();
    SHOP_CLOSED = status.closed;

    const statusBox = document.getElementById("shop-status");
    if (status.closed) {
      statusBox.innerText = `â›” å·²çµå–®ï¼ˆ${status.closeAt.toLocaleString()}ï¼‰`;
      statusBox.style.color = "red";
    } else {
      statusBox.innerText = `ğŸŸ¢ çµå–®æ™‚é–“ï¼š${status.closeAt.toLocaleString()}`;
      statusBox.style.color = "green";
    }

    const q = query(
      collection(db, "products", SHOP_ID, "items"),
      where("enabled", "==", true),
      orderBy("sort", "asc")
    );

    const snap = await getDocs(q);
    const container = document.getElementById("product-list");
    container.innerHTML = "";

    snap.forEach(docSnap => {
      const p = docSnap.data();

      const btn = document.createElement("button");
      btn.innerText = SHOP_CLOSED ? "å·²çµå–®" : "åŠ å…¥è³¼ç‰©è»Š";
      btn.disabled = SHOP_CLOSED;

      btn.onclick = () => {
        if (!SHOP_CLOSED) {
          upsertMyOrder({
            productId: docSnap.id,
            name: p.name,
            price: p.price
          });
        }
      };

      const div = document.createElement("div");
      div.style.marginBottom = "6px";
      div.innerHTML = `${p.name} $${p.price} `;
      div.appendChild(btn);
      container.appendChild(div);
    });
  }

  // =========================
  // åŠ å…¥è³¼ç‰©è»Šï¼ˆä¸€äººä¸€å–®ï¼‰
  // =========================
  async function upsertMyOrder(item) {
    const profile = await liff.getProfile();
    const orderId = `${SHOP_ID}_${profile.userId}`;
    const ref = doc(db, "orders", orderId);
    const snap = await getDoc(ref);

    let items = [];
    if (snap.exists()) items = snap.data().items || [];

    const idx = items.findIndex(i => i.productId === item.productId);
    if (idx >= 0) items[idx].qty += 1;
    else items.push({ ...item, qty: 1 });

    const totalAmount = items.reduce((s, i) => s + i.price * i.qty, 0);

    await setDoc(ref, {
      shopId: SHOP_ID,
      userId: profile.userId,
      displayName: profile.displayName,
      items,
      totalAmount,
      updatedAt: serverTimestamp()
    });
  }

  // =========================
  // å³æ™‚è³¼ç‰©è»Š
  // =========================
  async function watchCart() {
    const profile = await liff.getProfile();
    const ref = doc(db, "orders", `${SHOP_ID}_${profile.userId}`);
    const submitBtn = document.getElementById("submit-btn");

    onSnapshot(ref, snap => {
      const cart = document.getElementById("cart");
      const total = document.getElementById("cart-total");

      if (!snap.exists()) {
        cart.innerHTML = "<i>å°šæœªåŠ å…¥ä»»ä½•å•†å“</i>";
        total.innerText = "";
        return;
      }

      const data = snap.data();
      cart.innerHTML = "";

      data.items.forEach(i => {
        const div = document.createElement("div");
        div.innerText = `${i.name} Ã— ${i.qty} = $${i.price * i.qty}`;
        cart.appendChild(div);
      });

      total.innerText = `ğŸ’° ç¸½é‡‘é¡ï¼š$${data.totalAmount}`;

      submitBtn.disabled = SHOP_CLOSED || !!data.submittedAt;
      submitBtn.innerText = SHOP_CLOSED
        ? "å·²çµå–®"
        : data.submittedAt ? "å·²é€å‡º" : "ğŸ“¤ é€å‡ºè¨‚å–®";
    });

    submitBtn.onclick = async () => {
      if (SHOP_CLOSED) return;
      await updateDoc(ref, { submittedAt: serverTimestamp() });
      alert("âœ… è¨‚å–®å·²é€å‡º");
    };
  }

  // =========================
  // LIFF åˆå§‹åŒ–
  // =========================
  const LIFF_ID = "2008849957-uFo5FsLU";

  liff.init({ liffId: LIFF_ID })
    .then(() => {
      if (!liff.isLoggedIn()) {
        liff.login();
        return;
      }
      return liff.getProfile();
    })
    .then(profile => {
      if (!profile) return;
      document.getElementById("status").innerText = "ç™»å…¥æˆåŠŸ";
      document.getElementById("name").innerText = "ä½ å¥½ï¼Œ" + profile.displayName;
      loadProducts();
      watchCart();
    })
    .catch(err => {
      document.getElementById("status").innerText = "éŒ¯èª¤ï¼š" + err;
      console.error(err);
    });
</script>

</body>
</html>
