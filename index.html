<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>LIFF åœ˜è³¼</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>

<h2 id="status">è¼‰å…¥ä¸­...</h2>
<p id="name"></p>

<h3>ğŸ›’ å•†å“åˆ—è¡¨</h3>
<div id="product-list"></div>

<hr>

<h3>ğŸ› æˆ‘çš„è³¼ç‰©è»Š</h3>
<div id="cart"></div>
<p id="cart-total"></p>
<button id="submit-btn" style="display:none;">ğŸ“¤ é€å‡ºè¨‚å–®</button>

<hr>

<h3>ğŸ“¦ å·²è³¼è²·æ¸…å–®</h3>
<div id="submitted"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore,
  collection,
  query,
  where,
  orderBy,
  getDocs,
  doc,
  setDoc,
  getDoc,
  updateDoc,
  deleteDoc,
  serverTimestamp,
  onSnapshot
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAk5SaAAvifvTV3dUW4mddRvvgySbdIysc",
  authDomain: "line-shop-ef578.firebaseapp.com",
  projectId: "line-shop-ef578",
  storageBucket: "line-shop-ef578.firebasestorage.app",
  messagingSenderId: "909569598609",
  appId: "1:909569598609:web:e97cd2760f1df886114b30"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const SHOP_ID = "shop001";
let profile = null;

// =====================
// å•†å“åˆ—è¡¨ + å·²è³¼è²·äººæ•¸
// =====================
async function loadProducts() {
  const q = query(
    collection(db, "products", SHOP_ID, "items"),
    where("enabled", "==", true),
    orderBy("sort")
  );

  const snap = await getDocs(q);
  const box = document.getElementById("product-list");
  box.innerHTML = "";

  snap.forEach(pDoc => {
    const p = pDoc.data();

    const div = document.createElement("div");
    div.innerHTML = `
      ${p.name} $${p.price}
      <button>åŠ å…¥è³¼ç‰©è»Š</button>
    `;

    div.querySelector("button").onclick = () =>
      addToCart(pDoc.id, p.name, p.price);

    box.appendChild(div);
  });
}

// =====================
// åŠ å…¥è³¼ç‰©è»Šï¼ˆ+1ï¼‰
// =====================
async function addToCart(pid, name, price) {
  const ref = doc(db, "orders", `${SHOP_ID}_${profile.userId}`);
  const snap = await getDoc(ref);

  let items = [];
  let createdAt = serverTimestamp();

  if (snap.exists()) {
    items = snap.data().items || [];
    createdAt = snap.data().createdAt;
  }

  const idx = items.findIndex(i => i.productId === pid);
  if (idx >= 0) items[idx].qty += 1;
  else items.push({ productId: pid, name, price, qty: 1 });

  const totalAmount = items.reduce((s, i) => s + i.price * i.qty, 0);

  await setDoc(ref, {
    shopId: SHOP_ID,
    userId: profile.userId,
    displayName: profile.displayName,
    items,
    totalAmount,
    createdAt,
    updatedAt: serverTimestamp()
  });
}

// =====================
// å³æ™‚è³¼ç‰©è»Šï¼ˆ+ / -ï¼‰
// =====================
function watchCart() {
  const ref = doc(db, "orders", `${SHOP_ID}_${profile.userId}`);

  onSnapshot(ref, snap => {
    const cart = document.getElementById("cart");
    const total = document.getElementById("cart-total");
    const submitBtn = document.getElementById("submit-btn");

    cart.innerHTML = "";
    if (!snap.exists()) {
      cart.innerHTML = "<i>å°šæœªåŠ å…¥å•†å“</i>";
      submitBtn.style.display = "none";
      return;
    }

    const data = snap.data();
    if (data.submittedAt) {
      cart.innerHTML = "<i>å·²é€å‡ºè¨‚å–®</i>";
      submitBtn.style.display = "none";
      showSubmitted(data);
      return;
    }

    data.items.forEach(i => {
      const row = document.createElement("div");
      row.innerHTML = `
        ${i.name} 
        <button>-</button> ${i.qty} <button>+</button>
        = $${i.price * i.qty}
      `;

      row.children[0].onclick = () => updateQty(i.productId, -1);
      row.children[2].onclick = () => updateQty(i.productId, +1);

      cart.appendChild(row);
    });

    total.innerText = `ç¸½é‡‘é¡ï¼š$${data.totalAmount}`;
    submitBtn.style.display = "block";
    submitBtn.onclick = submitOrder;
  });
}

// =====================
// æ›´æ–°æ•¸é‡
// =====================
async function updateQty(pid, delta) {
  const ref = doc(db, "orders", `${SHOP_ID}_${profile.userId}`);
  const snap = await getDoc(ref);
  if (!snap.exists()) return;

  let items = snap.data().items;
  items = items.map(i =>
    i.productId === pid ? { ...i, qty: Math.max(0, i.qty + delta) } : i
  ).filter(i => i.qty > 0);

  const totalAmount = items.reduce((s, i) => s + i.price * i.qty, 0);
  await updateDoc(ref, { items, totalAmount, updatedAt: serverTimestamp() });
}

// =====================
// é€å‡ºè¨‚å–®
// =====================
async function submitOrder() {
  const ref = doc(db, "orders", `${SHOP_ID}_${profile.userId}`);
  await updateDoc(ref, { submittedAt: serverTimestamp() });
}

// =====================
// å·²è³¼è²·æ¸…å–®ï¼ˆå¯åæ‚”ï¼‰
// =====================
async function showSubmitted(data) {
  const box = document.getElementById("submitted");
  box.innerHTML = "";

  data.items.forEach(i => {
    box.innerHTML += `<div>${i.name} Ã— ${i.qty}</div>`;
  });

  const shop = await getDoc(doc(db, "products", SHOP_ID));
  if (!shop.exists() || !shop.data().closeAt) return;

  const deadline = shop.data().closeAt.toDate();
  deadline.setDate(deadline.getDate() - 1);

  if (new Date() < deadline) {
    const btn = document.createElement("button");
    btn.innerText = "âŒ åæ‚”åˆªé™¤è¨‚å–®";
    btn.onclick = async () =>
      await deleteDoc(doc(db, "orders", `${SHOP_ID}_${profile.userId}`));
    box.appendChild(btn);
  }
}

// =====================
// LIFF init
// =====================
liff.init({ liffId: "2008849957-uFo5FsLU" })
  .then(() => liff.isLoggedIn() ? liff.getProfile() : liff.login())
  .then(p => {
    profile = p;
    document.getElementById("status").innerText = "ç™»å…¥æˆåŠŸ";
    document.getElementById("name").innerText = "ä½ å¥½ï¼Œ" + p.displayName;
    loadProducts();
    watchCart();
  });
</script>
</body>
</html>
