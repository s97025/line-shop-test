<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>LIFF åœ˜è³¼</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
  button { margin:2px; }
  button:disabled { opacity:0.5; }
  .card { border:1px solid #ddd; padding:8px; margin-bottom:8px; }
  .small { font-size:12px; color:#555; }
</style>
</head>
<body>

<h2 id="status">è¼‰å…¥ä¸­...</h2>
<p id="name"></p>
<div id="shop-status" style="font-weight:bold;margin-bottom:10px;"></div>

<h3>ğŸ›’ å•†å“åˆ—è¡¨</h3>
<div id="product-list"></div>

<hr>

<h3>ğŸ§º è³¼ç‰©è»Šï¼ˆå°šæœªé€å‡ºï¼‰</h3>
<div id="draft-cart"><i>å°šæœªåŠ å…¥ä»»ä½•å•†å“</i></div>
<p id="draft-total"></p>
<button id="submit-btn">ğŸ“¤ é€å‡ºè¨‚å–®</button>

<hr>

<h3>ğŸ“¦ å·²é€å‡ºè¨‚å–®</h3>
<div id="submitted-orders"><i>å°šç„¡å·²é€å‡ºè¨‚å–®</i></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, query, where, orderBy,
  getDocs, doc, setDoc, getDoc, updateDoc, deleteDoc,
  serverTimestamp, onSnapshot, Timestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* =========================
   Firebase init
========================= */
const firebaseConfig = {
  apiKey: "AIzaSyAk5SaAAvifvTV3dUW4mddRvvgySbdIysc",
  authDomain: "line-shop-ef578.firebaseapp.com",
  projectId: "line-shop-ef578"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* =========================
   Global state
========================= */
const SHOP_ID = "shop001";
let USER = null;
let SHOP_CLOSE_AT = null;
let SHOP_CLOSED = false;

/* ğŸ”¥ æ–°å¢ï¼šå•†å“çµ±è¨ˆï¼ˆbuyerCountï¼‰ */
let productStats = {};

/* =========================
   Shop status
========================= */
async function loadShopStatus() {
  const snap = await getDoc(doc(db,"products",SHOP_ID));
  if (!snap.exists() || !snap.data().closeAt) return;

  SHOP_CLOSE_AT = snap.data().closeAt.toDate();
  SHOP_CLOSED = new Date() >= SHOP_CLOSE_AT;

  const el = document.getElementById("shop-status");
  el.innerText = SHOP_CLOSED
    ? `â›” å·²çµå–®ï¼ˆ${SHOP_CLOSE_AT.toLocaleString()}ï¼‰`
    : `ğŸŸ¢ çµå–®æ™‚é–“ï¼š${SHOP_CLOSE_AT.toLocaleString()}`;
  el.style.color = SHOP_CLOSED ? "red" : "green";
}

/* =========================
   å•†å“åˆ—è¡¨
========================= */
async function loadProducts() {
  const q = query(
    collection(db,"products",SHOP_ID,"items"),
    where("enabled","==",true),
    orderBy("sort","asc")
  );
  const snap = await getDocs(q);
  const box = document.getElementById("product-list");
  box.innerHTML = "";

  snap.forEach(d=>{
    const p=d.data();
    const div=document.createElement("div");
    div.className="card";
    div.dataset.productId = d.id;

    const stat = productStats[d.id];

    div.innerHTML = `
      <b>${p.name}</b> $${p.price}
      <div class="small stat">
        å·²è¨‚è³¼ï¼š${stat ? stat.buyerCount : 0}
      </div>
    `;

    const btn=document.createElement("button");
    btn.innerText="åŠ å…¥è³¼ç‰©è»Š";
    btn.disabled = SHOP_CLOSED;
    btn.onclick=()=>addToDraft(d.id,p);

    div.appendChild(btn);
    box.appendChild(div);
  });
}

/* =========================
   ğŸ”¥ æ–°å¢ï¼šå•†å“çµ±è¨ˆï¼ˆåªç®— submittedï¼‰
========================= */
function watchProductStats() {
  const q = query(
    collection(db,"orders"),
    where("shopId","==",SHOP_ID),
    where("status","==","submitted")
  );

  onSnapshot(q,snap=>{
    const stats = {};
    snap.forEach(docSnap=>{
      const data = docSnap.data();
      if (!data.items) return;
      data.items.forEach(item=>{
        if (!stats[item.productId]) {
          stats[item.productId] = { buyerCount: 0 };
        }
        stats[item.productId].buyerCount += item.qty;
      });
    });
    productStats = stats;
    updateProductStatsUI();
  });
}

function updateProductStatsUI() {
  document.querySelectorAll("[data-product-id]").forEach(div=>{
    const pid = div.dataset.productId;
    const stat = productStats[pid];
    const el = div.querySelector(".stat");
    if (el) {
      el.innerText = `å·²è¨‚è³¼ï¼š${stat ? stat.buyerCount : 0}`;
    }
  });
}

/* =========================
   Draftï¼ˆè³¼ç‰©è»Šï¼‰
========================= */
function draftRef(){
  return doc(db,"orders",`${SHOP_ID}_${USER.userId}_draft`);
}

async function addToDraft(pid,p){
  if (SHOP_CLOSED) return;
  const ref=draftRef();
  const snap=await getDoc(ref);
  let items=[];
  if (snap.exists()) items=snap.data().items||[];

  const i=items.find(x=>x.productId===pid);
  if (i) i.qty++;
  else items.push({productId:pid,name:p.name,price:p.price,qty:1});

  await setDoc(ref,{
    shopId:SHOP_ID,
    userId:USER.userId,
    status:"draft",
    items,
    updatedAt:serverTimestamp()
  });
}

function watchDraft(){
  onSnapshot(draftRef(),snap=>{
    const box=document.getElementById("draft-cart");
    const totalEl=document.getElementById("draft-total");
    if (!snap.exists()){
      box.innerHTML="<i>å°šæœªåŠ å…¥ä»»ä½•å•†å“</i>";
      totalEl.innerText="";
      return;
    }
    const d=snap.data();
    let total=0;
    box.innerHTML="";
    d.items.forEach(it=>{
      total+=it.price*it.qty;
      const div=document.createElement("div");
      div.innerHTML=`
        ${it.name} Ã— ${it.qty}
        <button ${SHOP_CLOSED?"disabled":""} onclick="updateQty('${it.productId}',1)">ï¼‹</button>
        <button ${SHOP_CLOSED?"disabled":""} onclick="updateQty('${it.productId}',-1)">ï¼</button>
        <button ${SHOP_CLOSED?"disabled":""} onclick="removeItem('${it.productId}')">åˆªé™¤</button>
      `;
      box.appendChild(div);
    });
    totalEl.innerText=`ğŸ’° ç¸½é‡‘é¡ï¼š$${total}`;
    document.getElementById("submit-btn").disabled = SHOP_CLOSED;
  });
}

window.updateQty=async(pid,delta)=>{
  const ref=draftRef();
  const snap=await getDoc(ref);
  if (!snap.exists()) return;
  let items=snap.data().items||[];
  items=items.map(i=>{
    if(i.productId===pid) i.qty+=delta;
    return i;
  }).filter(i=>i.qty>0);
  if (items.length===0) await deleteDoc(ref);
  else await updateDoc(ref,{items,updatedAt:serverTimestamp()});
};

window.removeItem=async(pid)=>{
  window.updateQty(pid,-999);
};

document.getElementById("submit-btn").onclick=async()=>{
  if (SHOP_CLOSED) return;
  const snap=await getDoc(draftRef());
  if (!snap.exists()) return;
  const data=snap.data();
  const now=new Date();
  const cancelDeadline=new Date(SHOP_CLOSE_AT.getTime()-24*60*60*1000);

  await setDoc(
    doc(db,"orders",`${SHOP_ID}_${USER.userId}_${now.getTime()}`),
    {
      ...data,
      status:"submitted",
      submittedAt:serverTimestamp(),
      cancelDeadline:Timestamp.fromDate(cancelDeadline)
    }
  );
  await deleteDoc(draftRef());
};

/* =========================
   Submitted orders
========================= */
function watchSubmitted(){
  const q=query(
    collection(db,"orders"),
    where("shopId","==",SHOP_ID),
    where("userId","==",USER.userId),
    where("status","==","submitted"),
    orderBy("submittedAt","desc")
  );
  onSnapshot(q,snap=>{
    const box=document.getElementById("submitted-orders");
    box.innerHTML="";
    if (snap.empty){
      box.innerHTML="<i>å°šç„¡å·²é€å‡ºè¨‚å–®</i>";
      return;
    }
    snap.forEach(d=>{
      const o=d.data();
      const div=document.createElement("div");
      div.className="card";
      let html=`<div class="small">é€å‡ºæ™‚é–“ï¼š${o.submittedAt?.toDate().toLocaleString()}</div>`;
      o.items.forEach(i=>{
        html+=`<div>${i.name} Ã— ${i.qty}</div>`;
      });
      const remain=o.cancelDeadline
        ? Math.max(0,Math.floor((o.cancelDeadline.toDate()-Date.now())/3600000))
        : 0;
      if (remain>0){
        html+=`<button onclick="cancelOrder('${d.id}')">åæ‚”å–æ¶ˆï¼ˆ${remain}hï¼‰</button>`;
      }
      div.innerHTML=html;
      box.appendChild(div);
    });
  });
}

window.cancelOrder=async(id)=>{
  await deleteDoc(doc(db,"orders",id));
};

/* =========================
   LIFF init
========================= */
const LIFF_ID="2008849957-uFo5FsLU";
liff.init({liffId:LIFF_ID}).then(()=>{
  if(!liff.isLoggedIn()) return liff.login();
  return liff.getProfile();
}).then(p=>{
  USER=p;
  document.getElementById("status").innerText="ç™»å…¥æˆåŠŸ";
  document.getElementById("name").innerText="ä½ å¥½ï¼Œ"+p.displayName;
  loadShopStatus().then(()=>{
    loadProducts();
    watchDraft();
    watchSubmitted();
    watchProductStats(); // ğŸ”¥ å•Ÿå‹•å•†å“çµ±è¨ˆ
  });
});
</script>
</body>
</html>
